version: '3.8'

# This creates a shared, temporary disk space.
# All services can read/write to this space.
volumes:
  scan-cache:

services:
  # Service 1: The API Gateway (The "Manager")
  # This is the ONLY service the public talks to.
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    ports:
      - "5000:5000"
    volumes:
      # Mount the code and the shared disk
      - .:/app
      - scan-cache:/tmp/scans
    command: python api_gateway.py
    depends_on:
      - content-scanner
      - http-auditor

  # Service 2: The "Fast" Content Scanner
  content-scanner:
    build:
      context: .
      dockerfile: Dockerfile.base
    volumes:
      - .:/app
      - scan-cache:/tmp/scans
    # Internal port, not visible to the public
    expose:
      - "5001"
    command: python content_scanner_service.py

  # Service 3: The "Slow" HTTP Auditor
  http-auditor:
    build:
      context: .
      dockerfile: Dockerfile.base
    volumes:
      - .:/app
      - scan-cache:/tmp/scans
    # Internal port, not visible to the public
    expose:
      - "5002"
    command: python http_auditor_service.py

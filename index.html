<!DOCTYPE html>
<html lang="en" class="bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Analytics Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Standard professional font stack -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Modern Cards */
        .pro-card { @apply bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm; }
        
        /* Polished KPI Cards */
        .kpi-card { @apply bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex flex-col; }
        .kpi-title { @apply text-sm font-medium text-slate-500; }
        .kpi-value { @apply text-3xl font-bold text-slate-900 tracking-tight mt-1; }
        .kpi-subtext { @apply text-xs font-medium text-slate-400 mt-2 flex items-center; }
        .kpi-download { @apply mt-auto pt-3 text-xs font-semibold text-indigo-600 hover:text-indigo-700 cursor-pointer inline-flex items-center transition-colors; }

        /* Modern Form Elements */
        .pro-input { @apply w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-slate-700 text-sm; }
        .pro-select { @apply w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-slate-700 text-sm appearance-none bg-no-repeat; background-position: right 1rem center; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        .pro-label { @apply block text-sm font-semibold text-slate-700 mb-1.5; }

        /* Buttons */
        .btn-primary { @apply px-6 py-2.5 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-500/30 transition-all active:scale-95 disabled:opacity-50; }
        .btn-secondary { @apply px-4 py-2 bg-white text-slate-700 text-sm font-medium rounded-lg border border-slate-300 shadow-sm hover:bg-slate-50 focus:ring-4 focus:ring-slate-200 transition-all disabled:opacity-50; }
        
        /* shadcn-style "Tabs" */
        .tabs-list { @apply inline-flex h-10 items-center justify-center rounded-md bg-slate-100 p-1 text-slate-500; }
        .tab-trigger { @apply inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-white transition-all disabled:pointer-events-none disabled:opacity-50 cursor-pointer; }
        .tab-trigger-active { @apply bg-white text-slate-900 shadow-sm; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Header -->
    <header class="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-200/80">
        <div class="container mx-auto max-w-7xl px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="p-2 bg-indigo-600 rounded-lg">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900">Markdown Analytics Suite</h1>
                    <p class="text-xs text-slate-500 font-medium">Professional documentation auditing & reporting</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/api" target="_blank" class="btn-secondary py-2 px-3">API Docs</a>
                <button id="refresh-analytics-btn" class="btn-primary py-2 px-3 flex items-center">
                    <svg id="refresh-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <svg id="refresh-spinner" class="w-4 h-4 mr-2 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Refresh Data
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto max-w-7xl p-8">
        
        <!-- Error Alert -->
        <div id="error-box" class="hidden mb-6 p-4 bg-rose-50 border-l-4 border-rose-500 text-rose-700 rounded-r-lg shadow-sm relative" role="alert">
            <div class="flex">
                <svg class="h-5 w-5 text-rose-500 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                <span class="block sm:inline font-medium" id="error-message"></span>
            </div>
        </div>
        
        <!-- Shared Folder Path Input -->
        <div class="mb-8">
             <label for="folder-path" class="pro-label">Folder to Analyze</label>
             <input type="text" id="folder-path" class="pro-input font-mono" value="/scan_data/mariadb-cloud">
        </div>

        <!-- Analytics Dashboard -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Analytics Dashboard</h2>
            <div id="analytics-kpi-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- KPI Cards will be loaded here by JS -->
                <!-- Loading State -->
                <div id="analytics-loading" class="col-span-4 h-48 flex items-center justify-center bg-white rounded-xl border border-slate-200/80 shadow-sm">
                    <div class="text-center">
                        <svg class="w-8 h-8 text-indigo-600 animate-spin mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-3 text-sm font-medium text-slate-600">Loading Dashboard Data...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Report Generator -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Report Generator</h2>
            <div class="pro-card">
                <h3 class="text-lg font-semibold text-slate-900">Generate Detailed Report</h3>
                <p class="text-sm text-slate-500 mt-1 mb-6">Select a report type and configure options to generate detailed analysis.</p>

                <!-- "Tabs" for selecting report type (matches screenshot) -->
                <div class="border-b border-slate-200">
                    <div class="tabs-list" role="tablist">
                        <button id="tab-code_blocks" class="tab-trigger tab-trigger-active" data-task="code_blocks">Code Blocks</button>
                        <button id="tab-link_audit" class="tab-trigger" data-task="link_audit">Link Audit</button>
                        <button id="tab-find_text" class="tab-trigger" data-task="find_text">Find Text</button>
                        <button id="tab-specific_url" class="tab-trigger" data-task="specific_url">Find URL</button>
                    </div>
                </div>

                <!-- Dynamic Options Area -->
                <div class="mt-6">
                    <!-- Options for Code Blocks -->
                    <div id="options-code_blocks" class="space-y-4">
                        <label for="code-block-mode" class="pro-label">Analysis Mode</label>
                        <select id="code-block-mode" class="pro-select">
                            <option value="untagged">Find Untagged Blocks</option>
                            <option value="specific_language">Find by Language Tag</option>
                        </select>
                        <div id="code-block-lang-input" class="hidden">
                            <label for="code-block-lang" class="pro-label">Language Tag</label>
                            <input type="text" id="code-block-lang" class="pro-input" placeholder="e.g., bash, sql, json">
                        </div>
                    </div>
                    <!-- Options for Link Audit -->
                    <div id="options-link_audit" class="space-y-4 hidden">
                         <label class="pro-label">Select HTTP Status Categories</label>
                        <div class="flex flex-wrap gap-3">
                            <label class="inline-flex items-center bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm cursor-pointer hover:border-indigo-300 transition-colors"><input type="checkbox" class="link-status-check mr-2 text-indigo-600 focus:ring-indigo-500 rounded" value="2xx"><span class="text-sm font-medium text-slate-700">2xx (Healthy)</span></label>
                            <label class="inline-flex items-center bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm cursor-pointer hover:border-indigo-300 transition-colors"><input type="checkbox" class="link-status-check mr-2 text-indigo-600 focus:ring-indigo-500 rounded" value="3xx"><span class="text-sm font-medium text-slate-700">3xx (Redirects)</span></label>
                            <label class="inline-flex items-center bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm cursor-pointer hover:border-indigo-300 transition-colors"><input type="checkbox" class="link-status-check mr-2 text-indigo-600 focus:ring-indigo-500 rounded" value="4xx" checked><span class="text-sm font-medium text-slate-700">4xx (Client Errors)</span></label>
                            <label class="inline-flex items-center bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm cursor-pointer hover:border-indigo-300 transition-colors"><input type="checkbox" class="link-status-check mr-2 text-indigo-600 focus:ring-indigo-500 rounded" value="5xx" checked><span class="text-sm font-medium text-slate-700">5xx (Server Errors)</span></label>
                            <label class="inline-flex items-center bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm cursor-pointer hover:border-indigo-300 transition-colors"><input type="checkbox" class="link-status-check mr-2 text-indigo-600 focus:ring-indigo-500 rounded" value="Other" checked><span class="text-sm font-medium text-slate-700">Timeout / Invalid</span></label>
                        </div>
                    </div>
                    <!-- Options for Find Text -->
                    <div id="options-find_text" class="space-y-2 hidden">
                         <label for="find-text-input" class="pro-label">Search Text</label>
                         <input type="text" id="find-text-input" class="pro-input" placeholder="Enter text to search for...">
                    </div>
                    <!-- Options for Specific URL -->
                    <div id="options-specific_url" class="space-y-2 hidden">
                         <label for="specific-url-input" class="pro-label">Search URL</Fabel>
                         <input type="text" id="specific-url-input" class="pro-input" placeholder="Enter URL to search for...">
                    </div>
                </div>

                <!-- Scan Button -->
                <div class="mt-6 pt-6 border-t border-slate-100 flex justify-end">
                    <button id="scan-btn" class="btn-primary w-full md:w-auto flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span id="scan-btn-text">Run Code Block Analysis</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTENT: RESULTS WRAPPER -->
        <div id="results-wrapper" class="hidden space-y-8">
            <div id="report-header" class="flex justify-between items-center">
                <h2 id="report-title" class="text-2xl font-bold text-slate-900">Report Results</h2>
                <button id="download-csv-btn" class="btn-secondary flex items-center">
                    <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export CSV
                </button>
            </div>
            
            <!-- Report Dashboard -->
             <div id="dashboard-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- KPI Cards generated here -->
            </div>

            <!-- Charts -->
            <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Charts generated here -->
            </div>

            <!-- Detailed Results List -->
            <div id="results-section" class="pro-card">
                <h3 id="report-title-detail" class="text-lg font-bold text-slate-900 mb-6 pb-4 border-b border-slate-100">Detailed Findings</h3>
                <div id="results-container" class="space-y-4">
                     <!-- File result cards generated here -->
                </div>
                <!-- Pagination -->
                <div id="pagination-controls" class="hidden flex justify-center items-center mt-8 space-x-4 pt-4 border-t border-slate-100">
                    <button id="prev-page-btn" class="btn-secondary px-3 py-1.5 text-xs">Previous</button>
                    <span id="page-info" class="text-sm font-medium text-slate-600">Page 1 of 1</span>
                    <button id="next-page-btn" class="btn-secondary px-3 py-1.5 text-xs">Next</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Globals ---
        let codeBlocksChart, domainChart, statusChart;
        let lastReportData = {};
        let paginatedResults = [];
        let currentPage = 1;
        const resultsPerPage = 20;
        let activeTask = 'code_blocks'; // Default task

        // --- DOM Elements ---
        let DOMElements;

        document.addEventListener('DOMContentLoaded', () => {
            DOMElements = {
                // Main layout
                errorBox: document.getElementById('error-box'),
                errorMessage: document.getElementById('error-message'),
                loadingSpinner: document.getElementById('loading-spinner'),
                loadingText: document.getElementById('loading-text'),
                folderPathInput: document.getElementById('folder-path'),
                resultsWrapper: document.getElementById('results-wrapper'),
                // Analytics
                analyticsKpiGrid: document.getElementById('analytics-kpi-grid'),
                refreshAnalyticsBtn: document.getElementById('refresh-analytics-btn'),
                refreshIcon: document.getElementById('refresh-icon'),
                refreshSpinner: document.getElementById('refresh-spinner'),
                analyticsLoading: document.getElementById('analytics-loading'),
                // Scan Tabs
                tabButtons: document.querySelectorAll('.tab-trigger'),
                scanOptions: {
                    'code_blocks': document.getElementById('options-code_blocks'),
                    'link_audit': document.getElementById('options-link_audit'),
                    'find_text': document.getElementById('options-find_text'),
                    'specific_url': document.getElementById('options-specific_url')
                },
                scanBtn: document.getElementById('scan-btn'),
                scanBtnText: document.getElementById('scan-btn-text'),
                codeBlockMode: document.getElementById('code-block-mode'),
                codeBlockLangInput: document.getElementById('code-block-lang-input'),
                // Results
                reportHeader: document.getElementById('report-header'),
                reportTitle: document.getElementById('report-title'),
                downloadCsvBtn: document.getElementById('download-csv-btn'),
                dashboardSection: document.getElementById('dashboard-section'),
                chartsSection: document.getElementById('charts-section'),
                resultsContainer: document.getElementById('results-container'),
                paginationControls: document.getElementById('pagination-controls'),
                prevPageBtn: document.getElementById('prev-page-btn'),
                nextPageBtn: document.getElementById('next-page-btn'),
                pageInfo: document.getElementById('page-info'),
            };

            // --- Tab Switching Logic (shadcn-style) ---
            DOMElements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Update active button
                    DOMElements.tabButtons.forEach(btn => btn.classList.remove('tab-trigger-active'));
                    button.classList.add('tab-trigger-active');
                    
                    // Get task and update UI
                    activeTask = button.dataset.task;
                    Object.values(DOMElements.scanOptions).forEach(el => el.classList.add('hidden'));
                    if (DOMElements.scanOptions[activeTask]) {
                        DOMElements.scanOptions[activeTask].classList.remove('hidden');
                    }
                    DOMElements.scanBtnText.textContent = `Run ${button.textContent} Analysis`;
                });
            });

            // --- Dynamic Scan Options ---
            DOMElements.codeBlockMode?.addEventListener('change', (e) => {
                DOMElements.codeBlockLangInput.classList.toggle('hidden', e.target.value !== 'specific_language');
            });

            // --- Event Listeners ---
            DOMElements.scanBtn.addEventListener('click', runScan);
            DOMElements.refreshAnalyticsBtn.addEventListener('click', loadAnalyticsDashboard);
            DOMElements.downloadCsvBtn.addEventListener('click', downloadCSV);
            DOMElements.prevPageBtn.addEventListener('click', () => { if (currentPage > 1) displayPage(currentPage - 1); });
            DOMElements.nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(paginatedResults.length / resultsPerPage);
                if (currentPage < totalPages) displayPage(currentPage + 1);
            });
            
            // --- Helper Functions ---
            function showError(msg) { DOMElements.errorMessage.textContent = msg; DOMElements.errorBox.classList.remove('hidden'); window.scrollTo(0,0); }
            function hideError() { DOMElements.errorBox.classList.add('hidden'); }
            function setLoading(isLoading, text='Processing...') {
                DOMElements.loadingSpinner.classList.toggle('hidden', !isLoading);
                DOMElements.loadingText.textContent = text;
                DOMElements.scanBtn.disabled = isLoading;
                DOMElements.refreshAnalyticsBtn.disabled = isLoading;
                if (isLoading) DOMElements.resultsWrapper.classList.add('hidden');
            }
            function escapeHTML(str) {
                 if (typeof str !== 'string') return '';
                 return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }
            
            // --- Analytics Dashboard ---
            async function loadAnalyticsDashboard() {
                hideError(); 
                DOMElements.analyticsKpiGrid.innerHTML = '';
                DOMElements.analyticsLoading.classList.remove('hidden');
                DOMElements.refreshAnalyticsBtn.disabled = true;
                DOMElements.refreshIcon.classList.add('hidden');
                DOMElements.refreshSpinner.classList.remove('hidden');
                
                const folderPath = DOMElements.folderPathInput.value;
                if (!folderPath) { showError('Please enter a folder path.'); return; }

                try {
                    const response = await fetch('/get_analytics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_path: folderPath })
                    });
                    if (!response.ok) throw new Error((await response.json()).error || 'Analytics fetch failed');
                    renderAnalyticsDashboard((await response.json()).analytics);
                } catch (e) { showError(e.message); } 
                finally { 
                    DOMElements.analyticsLoading.classList.add('hidden');
                    DOMElements.refreshAnalyticsBtn.disabled = false;
                    DOMElements.refreshIcon.classList.remove('hidden');
                    DOMElements.refreshSpinner.classList.add('hidden');
                }
            }
            
            function renderAnalyticsDashboard(analytics) {
                 const grid = DOMElements.analyticsKpiGrid;
                 grid.innerHTML = '';
                 grid.innerHTML += createKpi('Files Scanned', analytics.files_scanned, 'indigo', 'Total markdown files');
                 grid.innerHTML += createKpi('Total Lines', analytics.total_lines.toLocaleString(), 'slate', 'Across all files');
                 grid.innerHTML += createKpi('Code Blocks', analytics.code_blocks.total.toLocaleString(), 'emerald', `${analytics.code_blocks.untagged} untagged`, 'csv-analytics-code');
                 grid.innerHTML += createKpi('Total Links', (analytics.links.total_external + analytics.links.total_internal).toLocaleString(), `${analytics.links.total_external} External`);
                 grid.innerHTML += createKpi('Stub Pages', analytics.content.stubs, 'yellow', 'Files < 100 words');
                 grid.innerHTML += createKpi('TODOs Found', analytics.content.todos, 'rose', 'TODO or FIXME tags');
                 
                 addAnalyticsCsvListeners();
            }

            function createKpi(title, value, color, subtext='', downloadId=null) {
                const colors = { indigo: 'bg-indigo-50 text-indigo-600', slate: 'bg-slate-100 text-slate-600', emerald: 'bg-emerald-50 text-emerald-600', blue: 'bg-blue-50 text-blue-600', red: 'bg-rose-50 text-rose-600', yellow: 'bg-yellow-50 text-yellow-600', rose: 'bg-rose-50 text-rose-600' };
                const dl = downloadId ? `<div id="${downloadId}" class="kpi-download">Download List</div>` : '';
                return `
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon-wrapper ${colors[color]}">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        </div>
                        <span class="kpi-title">${title}</span>
                    </div>
                    <div class="kpi-value">${value}</div>
                    <div class="flex-grow"></div>
                    ${subtext ? `<div class="kpi-subtext">${subtext}</div>` : ''}
                    ${dl}
                </div>`;
            }
            
            function addAnalyticsCsvListeners() {
                document.getElementById('csv-analytics-code')?.addEventListener('click', () => {
                    setLoading(true, "Generating untagged code block report...");
                    runScan(true, {
                        task: 'code_blocks',
                        options: { code_block_task: 'untagged' }
                    }).then(() => {
                        setLoading(false);
                        downloadCSV();
                    });
                });
            }

            // --- Main Analysis Function ---
            async function runScan(fromAnalytics = false, taskOverride = null) {
                hideError();
                const task = taskOverride ? taskOverride.task : activeTask;
                setLoading(true, task === 'link_audit' ? 'Running audit (this takes time)...' : 'Scanning...');
                
                const options = taskOverride ? taskOverride.options : {
                    link_audit_statuses: Array.from(document.querySelectorAll('.link-status-check:checked')).map(el => el.value),
                    code_block_task: document.querySelector('input[name="code-task"]:checked').value,
                    code_block_lang: document.getElementById('code-block-lang').value,
                    specific_url: document.getElementById('specific-url-input').value,
                    text_to_find: document.getElementById('find-text-input').value,
                };

                try {
                    const response = await fetch('/run_scan', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_path: DOMElements.folderPathInput.value, task, options })
                    });
                    if (!response.ok) throw new Error((await response.json()).error || 'Scan failed');
                    
                    const data = await response.json();
                    lastReportData = { ...data, task }; // Save for CSV
                    renderScanResults(data, task);
                    DOMElements.resultsWrapper.classList.remove('hidden');
                    if (!fromAnalytics) {
                        setTimeout(() => DOMElements.resultsWrapper.scrollIntoView({ behavior: 'smooth' }), 100);
                    }
                } catch (e) { showError(e.message); } finally { setLoading(false); }
            }
            
            // --- RENDER FUNCTIONS ---
            function renderScanResults(data, task) {
                DOMElements.dashboardSection.innerHTML = '';
                DOMElements.chartsSection.innerHTML = '';
                DOMElements.resultsContainer.innerHTML = '';
                DOMElements.paginationControls.classList.add('hidden');
                
                if (task === 'code_blocks') renderCodeBlockReport(data);
                else if (task === 'specific_url') renderSpecificUrlReport(data);
                else if (task === 'find_text') renderFindTextReport(data);
                else if (task === 'link_audit') renderBrokenLinkReport(data);
            }

            function createScanKpiCard(title, value, subtext = '') {
                DOMElements.dashboardSection.innerHTML += `
                    <div class="kpi-card">
                        <div class="kpi-title">${title}</div>
                        <div class="kpi-value">${value}</div>
                        ${subtext ? `<div class="kpi-subtext">${subtext}</div>` : ''}
                    </div>`;
            }

            function createChart(canvasId, type, chartData, customOptions = {}) {
                if (codeBlocksChart) codeBlocksChart.destroy();
                if (domainChart) domainChart.destroy();
                if (statusChart) statusChart.destroy();

                const chartContainer = DOMElements.chartsSection;
                chartContainer.innerHTML = ''; 
                
                const canvas = document.createElement('canvas');
                canvas.id = canvasId;
                const container = document.createElement('div');
                container.className = 'bg-white p-5 rounded-lg shadow h-80';
                container.appendChild(canvas);
                chartContainer.appendChild(container);
                
                const ctx = canvas.getContext('2d');
                const colors = ['#10b981', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6', '#ec4899', '#6b7280'];
                const options = { responsive: true, maintainAspectRatio: false, plugins: { ...customOptions } };
                const data = {
                    labels: chartData.labels,
                    datasets: [{ label: 'Count', data: chartData.data, backgroundColor: colors }]
                };

                if (canvasId === 'code-blocks-chart') codeBlocksChart = new Chart(ctx, { type, data, options });
                else if (canvasId === 'domain-chart') domainChart = new Chart(ctx, { type, data, options });
                else if (canvasId === 'status-chart') statusChart = new Chart(ctx, { type, data, options });
            }
            
            // --- Report-Specific Renderers ---
            
            function renderCodeBlockReport(data) {
                const { analytics, details } = data;
                DOMElements.reportTitle.textContent = 'Code Block Analysis';
                createScanKpiCard('Files Scanned', analytics.files_scanned);
                createScanKpiCard('Files with Issues', analytics.files_with_issues);
                createScanKpiCard('Total Code Blocks', analytics.total_blocks);
                createScanKpiCard('Total Unmarked', analytics.total_untagged, `${analytics.total_tagged} Marked`);

                if (analytics.total_blocks > 0) {
                    createChart('code-blocks-chart', 'doughnut', {
                        labels: ['Marked', 'Unmarked'], data: [analytics.total_tagged, analytics.total_untagged]
                    }, { legend: { position: 'bottom' } });
                }
                
                setupPagination(details, renderCodeBlockPage);
            }
            
            function renderCodeBlockPage(pageItems) {
                DOMElements.resultsContainer.innerHTML = '';
                if (pageItems.length === 0) {
                    DOMElements.resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No files found matching your criteria.</p>';
                    return;
                }
                pageItems.forEach(item => {
                    DOMElements.resultsContainer.innerHTML += `
                        <div class="pro-card p-4">
                            <h3 class="text-lg font-semibold">${escapeHTML(item.title)}</h3>
                            <p class="text-sm text-slate-500 font-mono mb-2">${escapeHTML(item.file)}</p>
                            <ul class="list-disc list-inside">
                                <li class="text-yellow-700"><strong>${item.untagged || item.count} ${item.type} Block(s)</strong> on lines: ${item.lines.join(', ')}</li>
                            </ul>
                        </div>`;
                });
            }

            function renderSpecificUrlReport(data) {
                const { details } = data;
                DOMElements.reportTitle.textContent = 'Specific URL Report';
                createScanKpiCard('Files with Link', details.length);
                
                setupPagination(details, (pageItems) => {
                    DOMElements.resultsContainer.innerHTML = '';
                    if (pageItems.length === 0) {
                        DOMElements.resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No files with that specific URL found.</p>';
                        return;
                    }
                    pageItems.forEach(item => {
                        let linksHtml = item.found_links.map(l => 
                            `<li class="text-sm">
                                <strong>Anchor:</strong> <span class="text-gray-700">${escapeHTML(l.text) || '<em>[No Anchor Text]</em>'}</span><br>
                                <strong class="text-blue-700">URL:</strong> <span class="text-blue-700" style="word-break: break-all;">${escapeHTML(l.link)}</span>
                             </li>`
                        ).join('');
                        DOMElements.resultsContainer.innerHTML += `
                            <div class="pro-card p-4">
                                <h3 class="text-lg font-semibold">${escapeHTML(item.title)}</h3>
                                <p class="text-sm text-slate-500 font-mono mb-2">${escapeHTML(item.file)}</p>
                                <ul class="list-none list-inside ml-4 space-y-1">${linksHtml}</ul>
                            </div>`;
                    });
                });
            }
            
            function renderFindTextReport(data) {
                const { details } = data;
                DOMElements.reportTitle.textContent = 'Find Text Report';
                createScanKpiCard('Files with Text', details.length);

                setupPagination(details, (pageItems) => {
                    DOMElements.resultsContainer.innerHTML = '';
                    if (pageItems.length === 0) {
                        DOMElements.resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No files with that text found.</p>';
                        return;
                    }
                    pageItems.forEach(item => {
                        let linesHtml = item.found_text.map(l => 
                            `<li class="text-sm">
                                <strong>Line ${l.line_num}:</strong> <span class="text-gray-700 bg-yellow-100 p-1 rounded">${escapeHTML(l.line_text)}</span>
                             </li>`
                        ).join('');
                        DOMElements.resultsContainer.innerHTML += `
                            <div class="pro-card p-4">
                                <h3 class="text-lg font-semibold">${escapeHTML(item.title)}</h3>
                                <p class="text-sm text-slate-500 font-mono mb-2">${escapeHTML(item.file)}</p>
                                <ul class="list-none list-inside ml-4 space-y-1">${linesHtml}</ul>
                            </div>`;
                    });
                });
            }

            function renderBrokenLinkReport(data) {
                const { analytics, details } = data;
                DOMElements.reportTitle.textContent = 'Link Audit Report';
                
                const status = analytics.status_counts;
                const totalBroken = (status['4xx'] || 0) + (status['5xx'] || 0) + (status['Timeout'] || 0) + (status['Connection Error'] || 0) + (status['Invalid URL'] || 0);
                
                createScanKpiCard('Links Checked', analytics.total_links_checked);
                createScanKpiCard('Healthy (2xx)', status['2xx'] || 0);
                createScanKpiCard('Redirects (3xx)', status['3xx'] || 0);
                createScanKpiCard('Broken', totalBroken, '4xx, 5xx, or Timeout');

                if (analytics.total_links_checked > 0) {
                    createChart('status-chart', 'doughnut', {
                        labels: Object.keys(status), data: Object.values(status)
                    }, { legend: { position: 'bottom' } });
                }
                
                setupPagination(details, (pageItems) => {
                    DOMElements.resultsContainer.innerHTML = '';
                    if (pageItems.length === 0) {
                        DOMElements.resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No links matching your filter were found.</p>';
                        return;
                    }
                    pageItems.forEach(item => {
                        let linksHtml = item.links.map(l => {
                            let color = 'text-green-700';
                            if (l.status_category === '3xx') color = 'text-blue-700';
                            if (l.status_category.match(/[45]xx|Timeout|Error|Invalid/)) color = 'text-red-700';
                            
                            return `<li class="text-sm">
                                        <strong>Anchor:</strong> <span class="text-gray-700">${escapeHTML(l.text) || '<em>[No Anchor Text]</em>'}</span><br>
                                        <strong class="${color}">[${l.status_code}]</strong> <span class="${color}" style="word-break: break-all;">${escapeHTML(l.link)}</span>
                                     </li>`
                        }).join('');
                        DOMElements.resultsContainer.innerHTML += `
                            <div class="pro-card p-4">
                                <h3 class="text-lg font-semibold">${escapeHTML(item.title)}</h3>
                                <p class="text-sm text-slate-500 font-mono mb-2">${escapeHTML(item.file)}</p>
                                <ul class="list-none list-inside ml-4 space-y-1">${linksHtml}</ul>
                            </div>`;
                    });
                });
            }

            // --- Pagination Logic ---
            function setupPagination(details, renderPageCallback) {
                paginatedResults = details;
                currentPage = 1;
                const totalPages = Math.ceil(paginatedResults.length / resultsPerPage);

                if (totalPages > 1) {
                    DOMElements.paginationControls.classList.remove('hidden');
                } else {
                    DOMElements.paginationControls.classList.add('hidden');
                }

                displayPage(1, renderPageCallback);
            }

            function displayPage(page, renderPageCallback) {
                currentPage = page;
                const totalPages = Math.ceil(paginatedResults.length / resultsPerPage);
                
                const startIndex = (page - 1) * resultsPerPage;
                const endIndex = startIndex + resultsPerPage;
                const pageItems = paginatedResults.slice(startIndex, endIndex);

                renderPageCallback(pageItems); // Call the specific renderer
                
                // Update pagination controls
                DOMElements.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                DOMElements.prevPageBtn.disabled = (currentPage === 1);
                DOMElements.nextPageBtn.disabled = (currentPage === totalPages);
            }
            
            // --- CSV EXPORT FUNCTION ---
            function downloadCSV() {
                if (!lastReportData.details) { alert("No detailed report to export."); return; }
                const { details } = lastReportData;
                const task = lastReportData.task;
                let csvContent = "data:text/csv;charset=utf-8,";
                const escapeCSV = (str) => `"${(String(str) || '').replace(/"/g, '""')}"`;
                let filename = `${task}_report.csv`;

                if (task === 'code_blocks') {
                    csvContent += "File,Title,Type,Count,Lines\n";
                    details.forEach(r => csvContent += `${escapeCSV(r.file)},${escapeCSV(r.title)},${escapeCSV(r.type)},${r.count},"${r.lines.join(', ')}"\n`);
                } else if (task === 'specific_url') {
                    csvContent += "File,Title,AnchorText,Link\n";
                    details.forEach(r => r.found_links.forEach(l => csvContent += `${escapeCSV(r.file)},${escapeCSV(r.title)},${escapeCSV(l.text)},${escapeCSV(l.link)}\n`));
                } else if (task === 'find_text') {
                    csvContent += "File,Title,LineNumber,LineText\n";
                    details.forEach(r => r.found_text.forEach(l => csvContent += `${escapeCSV(r.file)},${escapeCSV(r.title)},${l.line_num},${escapeCSV(l.line_text)}\n`));
                } else if (task === 'link_audit') {
                     csvContent += "File,Title,AnchorText,Link,StatusCode,StatusCategory\n";
                     details.forEach(r => r.links.forEach(l => csvContent += `${escapeCSV(r.file)},${escapeCSV(r.title)},${escapeCSV(l.text)},${escapeCSV(l.link)},${escapeCSV(l.status_code)},${escapeCSV(l.status_category)}\n`));
                } else {
                    alert("No export available for this report type."); return;
                }
                downloadFile(filename, csvContent);
            }
            
            function addAnalyticsCsvListeners() {
                // This is for the "Analytics" tab, to add download buttons to KPIs
                document.getElementById('csv-analytics-code')?.addEventListener('click', () => {
                    setLoading(true, "Generating untagged code block report...");
                    runScan(true, { // `true` forces it to be a scan
                        task: 'code_blocks',
                        options: { code_block_task: 'untagged' }
                    }).then(() => {
                        setLoading(false);
                        if(lastReportData.details && lastReportData.details.length > 0) {
                            downloadCSV(); // This will download the report we just ran
                        } else {
                            showError("No untagged code blocks found to export.");
                        }
                    });
                });
            }
            
            function downloadFile(filename, content) {
                const encodedUri = encodeURI(content);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // --- Init ---
            loadAnalyticsDashboard(); // Load dashboard on page load
        });
    </script>
</body>
</html>
